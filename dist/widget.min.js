!function(){"use strict";!function(e){if(!e)return;class s{constructor(s={}){this.debug=!!s.debug,this._requestIdCounter=0,this._pendingRequests=new Map,this._listeners=new Map,this._lastOpenMessageId=null,this._lastChangeMessageId=null,this._handleMessage=this._handleMessage.bind(this),e.addEventListener?e.addEventListener("message",this._handleMessage):console.error("[WidgetSDK] addEventListener is not available")}_log(e,s="log"){if(!this.debug&&"log"===s)return;const t="[WidgetSDK]",n="function"==typeof e?e():e;"warn"===s?console.warn(t,n):console.log(t,n)}_nextMessageId(){return++this._requestIdCounter}_handleMessage(e){const s=e.data;if(!s||"object"!=typeof s)return void this._log(()=>`Unknown event message: ${JSON.stringify(e)}`);this._log(()=>`Host -> ${JSON.stringify(s)}`);const{correlationId:t,name:n}=s;if(this._pendingRequests.has(t)){const e=this._pendingRequests.get(t);return this._pendingRequests.delete(t),void("InvalidMessageError"===n?e.reject(this._toError(s)):e.resolve(s))}if("Open"===n?this._lastOpenMessageId=s.messageId:"Change"===n&&(this._lastChangeMessageId=s.messageId),n&&this._listeners.has(n)){this._listeners.get(n).forEach(e=>{try{e(s)}catch(e){this._log(`Listener error for ${n}: ${e.message}`,"warn")}})}}_toError(e){const s=e&&e.errors&&e.errors[0]&&e.errors[0].error?e.errors[0].error:"Unknown error",t=new Error(s);return t.name=e&&e.name?e.name:"InvalidMessageError",t.details=e&&e.errors?e.errors:null,t.rawMessage=e||null,t}on(e,s){const t=this._listeners.get(e)||[];return t.includes(s)||(t.push(s),this._listeners.set(e,t)),()=>this.off(e,s)}onOpen(e){return this.on("Open",e)}onOpenPopup(e){return this.on("OpenPopup",e)}onSave(e){return this.on("Save",e)}onChange(e){return this.on("Change",e)}off(e,s){const t=this._listeners.get(e)||[],n=t.indexOf(s);n>-1&&t.splice(n,1)}sendRequest(s={}){const t=this._nextMessageId();return s.messageId=t,this._log(()=>`SDK -> ${JSON.stringify(s)}`),new Promise((n,r)=>{this._pendingRequests.set(t,{resolve:n,reject:r});try{("undefined"!=typeof parent?parent:e).postMessage(s,"*")}catch(e){this._pendingRequests.delete(t),r(e)}})}sendMessage(s={}){this._log(()=>`SDK -> ${JSON.stringify(s)}`);try{("undefined"!=typeof parent?parent:e).postMessage(s,"*")}catch(e){this._log(`postMessage error for ${s.name||"unknown"}: ${e.message}`,"warn")}}selectGoodFolder(){return this.sendRequest({name:"SelectGoodFolderRequest"})}showDialog(e,s=[{name:"Ok",caption:"ОК"}]){return this.sendRequest({name:"ShowDialogRequest",dialogText:e,buttons:s})}navigateTo(e,s="blank"){return this.sendRequest({name:"NavigateRequest",path:e,target:s})}update(e){return this.sendRequest({name:"UpdateRequest",updateState:e})}openFeedback(e){const s=this._getOpenMessageId(e);if(null===s)return this._log("OpenFeedback not sent: openMessageId is missing","warn"),null;const t={name:"OpenFeedback",correlationId:s};return this.sendMessage(t),t}setDirty(e){const s=this._getOpenMessageId(e);if(null===s)return this._log("SetDirty not sent: openMessageId is missing","warn"),null;const t={name:"SetDirty",messageId:this._nextMessageId()};return t.openMessageId=s,this.sendMessage(t),t}clearDirty(){const e={name:"ClearDirty",messageId:this._nextMessageId()};return this.sendMessage(e),e}validationFeedback(e,s=void 0,t=void 0){const n=this._getChangeMessageId(t);if(null===n)return this._log("ValidationFeedback not sent: changeMessageId is missing","warn"),null;const r={name:"ValidationFeedback",messageId:this._nextMessageId(),correlationId:n,valid:void 0!==e&&!!e};return r.message=void 0!==s?s:"Invalid data",this.sendMessage(r),r}showPopup(e,s){const t={name:"ShowPopupRequest",popupName:e};return void 0!==s&&(t.popupParameters=s),this.sendRequest(t)}closePopup(e){const s={name:"ClosePopup",messageId:this._nextMessageId()};return void 0!==e&&(s.popupResponse=e),this.sendMessage(s),s}_getOpenMessageId(e){return null!=e?e:this._lastOpenMessageId||null}_getChangeMessageId(e){return null!=e?e:this._lastChangeMessageId||null}destroy(){this._listeners.clear(),this._pendingRequests.forEach(e=>{try{const s=new Error("SDK destroyed");s.name="SDKDestroyed",e.reject(s)}catch(e){}}),this._pendingRequests.clear(),e.removeEventListener&&e.removeEventListener("message",this._handleMessage),this._log("SDK destroyed")}}const t={version:"0.1.0",create:e=>new s(e),WidgetSDKInstance:s};e.WidgetSDK=t}("undefined"!=typeof window?window:void 0)}();
